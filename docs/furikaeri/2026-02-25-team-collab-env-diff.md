# ふりかえり: チーム協働開発における環境差異問題

**日付**: 2026-02-25
**形式**: 5 Whys + Anti-Pattern分析
**対象**: チーム開発プロジェクトでの改行コード問題

---

## 1. セッションストーリー

1. 外部APIリトライ機能をApplication/Infrastructure層に追加し、mainにマージ済み
2. 別メンバーが同リポジトリをWSL/Ubuntu上のAIエージェント環境でcloneした
3. `git status` で全ファイル（多数）が modified と表示された
4. メンバーはまだ一切の作業を開始しておらず、cloneしただけの状態だった
5. `git ls-files --eol` で `.gitattributes` 未設定を確認
6. `git cat-file` をPowerShellパイプ経由で検証 → blobにCRLFと**誤診**
7. Python `subprocess` で直接バイナリ読み取り → blobはLFと判明
8. 真の原因はAIエージェントのサンドボックス内でのファイル操作による改行変換と推定

---

## 2. 5 Whys 分析

### 問題A: メンバー環境での全ファイルmodified

| # | Why | Answer |
|---|-----|--------|
| 1 | なぜ全ファイルがmodifiedになった？ | AIエージェントがファイル操作時に改行コードを変換した |
| 2 | なぜAIエージェントが改行コードを変換した？ | サンドボックス環境の設定が改行コードを意識していない |
| 3 | なぜエージェントの挙動を事前に把握していなかった？ | メンバーの開発環境を事前に共有する仕組みがなかった |
| 4 | なぜ環境共有の仕組みがなかった？ | チーム開発が初めてで、環境差異が問題になるという経験がなかった |
| 5 | なぜ経験不足がそのまま問題になった？ | リポジトリに `.gitattributes` のような環境差異を吸収するガードレールがなかった |

### 問題B: 調査時の誤診

| # | Why | Answer |
|---|-----|--------|
| 1 | なぜblobのCRLFと誤診した？ | `git cat-file` の出力をPowerShellパイプ経由でPythonに渡した |
| 2 | なぜパイプがLF→CRLF変換することを知らなかった？ | Windows PowerShell のテキストモード変換に関する知識不足 |
| 3 | なぜ検証方法を疑わなかった？ | `git ls-files --eol` が `i/lf` を示していたが、`cat-file` 結果と矛盾していることに気づくのが遅れた |

### 根本原因

1. **環境情報の事前共有がない**: チーム開発開始時に、メンバーの環境を把握する仕組みがない
2. **リポジトリの防御設定が不足**: `.gitattributes` がないため、環境差異がそのまま問題として顕在化する
3. **AIエージェントの副作用**: エージェントがファイル操作時に意図しない変更を行う可能性がある

---

## 3. Anti-Pattern: Implicit Environment Assumption（暗黙の環境前提）

**定義**: チームメンバー全員が同じ開発環境を使っていると暗黙に仮定し、環境差異を吸収するリポジトリ設定を省略すること。

**なぜ危険か**:
- 環境差異は「動くはずなのに動かない」という最も調査が困難な問題を引き起こす
- AIエージェントはそれぞれ独自のサンドボックスを持ち、挙動が異なる
- 問題が発生してからでは、原因の切り分けに大量の時間がかかる

**正しいパターン**:

| ❌ 暗黙の前提 | ✅ 明示的な設定 |
|---|---|
| `core.autocrlf` の個人設定に任せる | `.gitattributes` で改行コードを強制統一 |
| 「自分の環境で動くから大丈夫」 | `.editorconfig` でインデント・文字コードを統一 |
| 環境情報を記録しない | 環境チェックリストでメンバーの環境を記録 |

**原則**: 「個人の設定に依存するな。リポジトリの設定で統一せよ。」

---

## 4. 対策

### 対策1: リポジトリ初期化チェックリスト（✅ 今回対応済み）

`.gitattributes` を追加済み。今後の新規リポジトリでも初期化時に含める。

| ファイル | 目的 | 優先度 |
|---------|------|--------|
| `.gitattributes` | 改行コード統一 | **必須**（今回追加済み） |
| `.editorconfig` | インデント・文字コード統一 | 推奨（次回対応） |
| README の環境セクション | 前提環境の明記 | 推奨 |

### 対策2: `git-initial-setup` スキルの拡張

スキルに `.gitattributes` と `.editorconfig` の生成ステップを組み込み、新規リポジトリの初期化時に自動的にガードレールが敷かれるようにする。

### 対策3: AIエージェント利用ガイドライン

1. コミット前に `git diff --name-only` で変更ファイル一覧を確認する
2. 意図しないファイルが含まれている場合、`git checkout -- <ファイル>` で除外する
3. 大量の意図しない変更が出た場合、`git checkout -- .` でリセットしてやり直す

---

## 5. 余白の設計

**やらないこと**（意図的に残す余白）:
- pre-commit hookで改行コードを強制チェックしない（開発フローを重くしすぎない）
- AIエージェントの使用を制限しない（ツールの恩恵を受けつつ副作用に対処する）
- 環境チェックリストを自動化しない（まずは手動でチーム文化として定着させる）

**判断基準**: 「リポジトリの設定で防げるものはファイルで防ぐ。人のルールで防ぐべきものはガイドラインに留める。」

---

## 6. Next Actions

| # | アクション | 対象 | 時期 |
|---|-----------|------|------|
| 1 | `.editorconfig` 追加 | 対象リポジトリ | 別メンバーに依頼 |
| 2 | README に環境チェックリストセクション追加 | 対象リポジトリ | メンバー環境確認後 |
| 3 | `git-initial-setup` スキルに `.gitattributes` 生成を組み込み | skills_repository | 今回セッション |
| 4 | AIエージェント利用ガイドラインをチーム共有 | チーム運用 | 即時 |

---

## 7. 学び（Values との紐付け）

| Value | この事例での学び |
|-------|----------------|
| **基礎と型の追求** | `.gitattributes` はチーム開発の「型」。個人設定に依存せず、リポジトリ設定で環境差異を吸収するのが基礎 |
| **余白の設計** | ガードレールは最小限に。`.gitattributes`（自動防止）+ ガイドライン（人の判断）の二層構造 |
| **成長の複利** | 今回の経験を環境チェックリストとして形式知化すれば、次のチーム開発でも再利用可能 |
| **温故知新** | 改行コード問題は数十年前からある古い問題。AIエージェント時代にも形を変えて再発する |

---

## 8. 補足: 調査時の教訓

### PowerShell パイプでのバイナリ検証に注意

Windows PowerShellのパイプはテキストモードで動作し、LF→CRLF変換が発生する。
Git blobの改行コードを正確に検証するには、Python `subprocess` で直接バイナリ読み取りを行う。

```python
# ✅ 正確な検証方法
import subprocess
data = subprocess.run(
    ['git', 'cat-file', '-p', 'HEAD:.gitignore'],
    capture_output=True
).stdout
crlf = data.count(b'\r\n')
lf = data.count(b'\n') - crlf
print(f'CRLF={crlf}, LF={lf}')
```

```powershell
# ❌ 不正確（PowerShellパイプがLF→CRLF変換する）
# git cat-file -p HEAD:.gitignore | python -c "import sys; ..."
```

---

## 9. メタふりかえり

### 次回への改善点

KPT分析のリスト部分は `ask_user` の選択肢UIではなく、通常のマークダウンテキストで画面に出力する。
選択UIは選択後に内容が消えてしまい、会話履歴として残らない。
選択が必要な場面（優先度選択等）のみ `ask_user` を使用する。

→ `furikaeri-practice` スキル自体の改善として今回対応。
